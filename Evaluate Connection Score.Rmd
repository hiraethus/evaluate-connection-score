---
title: "Evaluating Connection Score on Unordered Query Gene Signatures"
params:
  N: 500
  Random.Sigs: 2000
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This document attempts to establish if connection score is a good metric for choosing candidate therapies
using Gene Expression Connectivity Map according to the method detailed in Zhang and Gantt 2008. Specifically, we will look at a theoretical unordered query gene signature that matches the top m of N genes exactly (in terms of sign - rank is not included in unordered signatures) and establish the distribution of connection score as m tends to N.

It is also intended for p values to be calculated for each of these scores by randomly generating query 
gene signatures and seeing if how man of the scores are higher than or equal to the synthesised connection 
score for that value of m.

# Creating a synthetic Reference Profile and Query Gene Signature

We will create our synthetic Reference Profile as simply an ordered rank of probes from 1 to N with 
alternative signs to represent upregulation and downregulation of the genes. Note that we select N = `r params$N`.

```{r Create Ref Profile}
reference.profile <- seq(params$N)
even.probes <- seq(2, params$N, by = 2)

reference.profile[even.probes] <- -reference.profile[even.probes]
```

To create the unordered query gene signatures, we can derive these values by taking the sign of these reference profile values:

```{r Create Unordered Query Gene Signature}
query.gene.sig <- sign(reference.profile)
```

# Methods

## Calculate Maximum Connection Strength

```{r Calculate Maximum Connection Strength}
max.connection.strength <- function(N, m) {
  x <- sapply(seq(m), function(i) {
    N - i + 1
  })
  
  sum(x)
}
```

## Calculate Connection Strength

```{r Calculate Connection Strength method}
calc.connection.strength <- function(query.gene.sig, reference.profile, m, sig.offset = 0) {
  sig.idx <- seq(from=1+sig.offset, by=1, length.out=m)
  query.gene.sig.sub <- query.gene.sig[sig.idx]
  reference.profile.sub <- reference.profile[sig.idx]
  
  sum(query.gene.sig.sub * reference.profile.sub)
}
```

## Calculate Connection Score

Connection score is simply dividing the connection strength by the theoretical maximum connection strength.

## Random signatures

Let's generate `r  params$Random.Sigs`.

```{r Create random signatures}
random.profiles <- lapply(seq(params$Random.Sigs), function(i) {
  ranks <- rank(rnorm(n = params$N))
  signs <- sign(rnorm(n= params$N, mean = 0, sd=1))

  ranks * signs
})

```

# Running the example
Given N = `r params$N` and m from sizes 1 to N...

```{r Calculate Theoretical Scores}

library(parallel)

Ms <- seq(params$N)
n.cores <- 4
groups <- sort(rep(seq(4), params$N/n.cores))
split.Ms <- split(Ms, groups)
scores.group <- mclapply(split.Ms, function(Ms.sublist) {
  scores <- sapply(Ms, function(m) {
    max.cs <- max.connection.strength(params$N, m)
    cs <- calc.connection.strength(query.gene.sig, reference.profile, m)
  
    cs/max.cs
  })
  
  return(scores)
})

# flatten the list of scores into one list
scores <- unlist(scores.group)

result <- data.frame(m=Ms, cs=scores)
```

## Lowest Connection Scores
```{r Lowest Connection Scores varying m, echo=F}
knitr::kable(head(result, n=20))
```

## Highest Connection Scores
```{r Highest Connection Scores varying m, echo=F}
knitr::kable(tail(result, n=20))
```

```{r Plot Connection Scores, echo=F}
plot(result)
```

As we can see form the plot, Connection Score grows exponentially as m converges on N. More importantly, as m converges on N, the connection score tends towards 1.0. This means that connection 
score varies with the length of m, implying that a higher connection score is derived when our query 
gene signature is more complete.

# Calculate P Values

```{r Calculate P Values}
p.vals <- apply(result, 1, function(row) {
  m <- row[1]
  cs <- row[2]
  
  theoretical.max.score <- max.connection.strength(params$N, m)
  
  random.connection.scores <- lapply(random.profiles, function(rand.prof) {
    random.strength <- calc.connection.strength(query.gene.sig, rand.prof, m)
    random.score <- random.strength / theoretical.max.score
  })
  
  num.stronger.scores <- length(which(random.connection.scores > cs))
  num.stronger.scores / params$Random.Sigs
})

significant.result<- cbind(result, p.vals)

```

### P vals for Lowest m
```{r Lowest significant p vals, echo=F}
knitr::kable(head(significant.result, n=20))
```

### P vals for Highest m
```{r Highest significant p vals, echo=F}
knitr::kable(tail(significant.result, n=20))
```

```{r Plot significant p vals, echo=F}
plot(x= significant.result$m, y= significant.result$p.vals)
```

We can see in the results that as m increases, p becomes more significant implying that random query 
gene signatures are less likely to be as high as the synthetic unordered query gene signature as 
the query gene signature gets longer.

# Offset effect

If the query synthetic gene signature is offset by an amount F, then I anticipate that the connection 
score will go up. This is because, by offsetting the synthetic gene signature, lower ranked, and therefore large rank values will be multiplied together with the reference profile. This could 
imply that the connection score is biased towards finding matching lower ranked genes rather than the 
highest ones.

## Example
Let us choose a nominal m:
```{r Set m as 50}
m <- 50
```
If we assume m = `r m` and leave N = `r params$N`, we can perform connectivity map for all offsets 
from starting at offset F = 0 until the offset is N - m which is `r params$N - m`. I believe that if we plot 
the offset of our matching synthetic query gene signatures against connection score that the connection score will increase significantly.

```{r Perform offset analysis}

offsets <- seq(0, params$N - m)

offset.connection.scores <- sapply(offsets, function(offset) {
  max.cs <- max.connection.strength(params$N, m)
  cs <- calc.connection.strength(query.gene.sig, reference.profile, m, sig.offset = offset)
  
  cs/max.cs
})

offset.result <- data.frame(offset=offsets, cs=offset.connection.scores)


```

### Lowest Offset Scores
```{r Lowest Offset Scores, echo=F}
knitr::kable(head(offset.result,n=20))
```

### Highest Offset Scores
```{r Highest Offset Scores, echo=F}
knitr::kable(tail(offset.result,n=20))
```

```{r Plot Offset effect, echo=F}
plot(offset.result)
```

These data show a significant effect when the offset of the synthetic query gene signature is increased. In a real world setting, this would imply that, if the unordered  query signature consisted of a set of genes exactly matching the sign of the ranks of those in the reference profile, a higher 
connection score would be observed if those genes were ranked lower in the reference profile, i.e. larger integer values.
